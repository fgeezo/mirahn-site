# Build updated index.html with new background, Mr Fox image, snoopy mapping without adjacent duplicates,
# smaller UI, and refined layout.
from PIL import Image, ImageDraw
import base64, io, json
from string import Template

def to_webp_datauri(path, max_w, max_h, quality):
    im = Image.open(path).convert("RGBA")
    w, h = im.size
    scale = min(max_w / w, max_h / h, 1.0)
    if scale < 1.0:
        im = im.resize((int(w * scale), int(h * scale)), Image.Resampling.LANCZOS)
    bio = io.BytesIO()
    im.save(bio, format="WEBP", quality=quality, method=6)
    return "data:image/webp;base64," + base64.b64encode(bio.getvalue()).decode("ascii")

assets = {
"snoopy1":"/mnt/data/90cabb03-7706-432a-9bbe-68f9ff54e1a2.png",
"snoopy2":"/mnt/data/88f7be02-6156-4720-b8ad-29991b8e2f0f.png",
"snoopy3":"/mnt/data/7d756cc2-283f-46f4-bd6b-d798be3e0b4b.png",
"snoopy4":"/mnt/data/704ae2d4-f560-4b7b-94b3-66d9a8d4564f.png",
"snoopy5":"/mnt/data/bd0e0e44-e78c-48ae-aea1-079be5cce84b.jpg",
"cow1":"/mnt/data/18f24fd6-a8cc-476b-9bcd-9ed7ac511fc8.png",
"cow2":"/mnt/data/a63a5e18-ae75-4124-8794-d186963a0569.png",
"spongebob":"/mnt/data/2c7f6f78-1d25-4313-beb9-1c9f5fd5acfb.png",
"parrots":"/mnt/data/b8301d19-a3dd-4276-a768-a10f8561c99b.png",
"fox":"/mnt/data/f6fc3bd0-2cbb-4a76-8ab7-4481d8f4801d.png",   # new orange tree fox image
"steam":"/mnt/data/ac4c5d74-0301-49c1-908f-4b907194bd54.png",
"geo":"/mnt/data/9172d4cf-328b-4d6b-a372-e46f01a8faf7.png",
"bgAero":"/mnt/data/8572b7f2-a7dc-46ed-9d34-0d65954d3ad5.png" # new background
}

specs = {
"snoopy1":(380,380,46),"snoopy2":(380,380,46),"snoopy3":(380,380,46),
"snoopy4":(380,380,46),"snoopy5":(380,380,46),
"cow1":(900,900,42),"cow2":(900,900,42),
"spongebob":(1100,700,42),"parrots":(1000,1100,42),"fox":(1200,1200,50),
"steam":(900,900,70),"geo":(700,700,65),"bgAero":(2560,1440,45)
}

data = {k: to_webp_datauri(v, *specs[k]) for k,v in assets.items()}
snoopy_list = [data[f"snoopy{i}"] for i in range(1,6)]

def messenger_buddy_png(size=32):
    im=Image.new("RGBA",(size,size),(0,0,0,0))
    d=ImageDraw.Draw(im)
    def circ(x,y,r,fill): d.ellipse((x-r,y-r,x+r,y+r), fill=fill)
    circ(12,22,8,(56,146,255,255)); circ(12,10,5,(120,200,255,255))
    circ(20,22,8,(90,210,90,255));   circ(20,10,5,(160,255,160,255))
    d.ellipse((9,7,11,9), fill=(255,255,255,150)); d.ellipse((17,7,19,9), fill=(255,255,255,150))
    bio=io.BytesIO(); im.save(bio, format="PNG")
    return "data:image/png;base64,"+base64.b64encode(bio.getvalue()).decode("ascii")
favicon = messenger_buddy_png()

tmpl = Template("""<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mirahn's Space</title>
<link rel="icon" type="image/png" href="$FAVICON"/>
<style>
:root{ --shadow:rgba(0,0,0,.25); --text:#0b1f2a; --xp1:#6aa0df; --xp2:#2e5fa8; }
*{box-sizing:border-box}
body{
  margin:0; font-family:"Segoe UI",Tahoma,Verdana,sans-serif; color:var(--text);
  background:
    linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.05)),
    url('$BG');
  background-repeat:no-repeat;
  background-position:center top;
  background-size:contain; /* show full image, no zoom */
  background-color:#e6f8ff;
  min-height:100vh;
}
.grid{ --row:9px; display:grid; grid-template-columns:repeat(12,1fr); grid-auto-rows:var(--row); grid-auto-flow:dense; gap:12px; padding:20px; max-width:1100px; margin:0 auto; }

.win{ position:relative; border-radius:8px; overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78)); box-shadow:0 9px 20px var(--shadow), inset 0 1px 0 rgba(255,255,255,.85); outline:1px solid rgba(0,0,0,.06); }
.titlebar{ height:28px; display:flex; align-items:center; justify-content:space-between; padding:0 8px; background:linear-gradient(180deg, var(--xp1), var(--xp2)); color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.35); border-bottom:1px solid rgba(255,255,255,.5); }
.titlebar .caption{ font-weight:600; font-size:13px; }
.buttons{ display:flex; gap:4px; }
.btnBox{ width:15px; height:15px; border-radius:3px; display:grid; place-items:center; background:linear-gradient(180deg,#fdfdfd,#d6e8ff); border:1px solid rgba(0,0,0,.25); color:#123; font-weight:700; font-size:10px; line-height:1; }
.content{ padding:8px; font-size:13px; }

/* Image windows */
.thumb img{ width:100%; height:auto; display:block; border-radius:6px; box-shadow:0 5px 12px rgba(0,0,0,.16); }

/* Music player */
.playerWrap{ display:flex; flex-direction:column; gap:8px; }
.album{ display:grid; place-items:center; }
.album .frame{ width:clamp(190px, 52%, 300px); aspect-ratio:1/1; border-radius:12px; overflow:hidden; box-shadow:0 10px 22px rgba(0,0,0,.23); }
.album img{ width:100%; height:100%; object-fit:cover; display:block; }
.controlsBar{ display:flex; flex-direction:column; gap:6px; }
.ctrlRow{ display:flex; align-items:center; justify-content:center; gap:8px; }
.ctrlRow.right{ justify-content:flex-end; }
.track{ font-size:13px; color:#113a5a; font-weight:700; text-align:center; }
.seek{ width:100%; accent-color:#49a5ff; }
.volume{ width:150px; accent-color:#49a5ff; }

a.cta{ display:inline-block; padding:8px 12px; border-radius:9px; font-weight:700; background:linear-gradient(180deg,#eafff7,#c6ffe8); box-shadow:0 5px 10px rgba(0,170,120,.25), inset 0 1px 0 #fff; text-decoration:none; color:#145a46; }
.steambox{ text-align:center; }
.steambtn{ display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:10px; font-weight:700; text-decoration:none; color:#0a2b4a; background:linear-gradient(180deg,#eff7ff,#d9eaff); box-shadow:0 6px 12px rgba(0,80,200,.25), inset 0 1px 0 #fff; }
.steambtn img{ width:36px; height:36px; }

@media(max-width:1200px){ .grid{ grid-template-columns:repeat(8,1fr);} }
@media(max-width:860px){ .grid{ grid-template-columns:repeat(4,1fr); padding:14px;} }
</style>
</head>
<body>
<div class="grid" id="grid">

  <!-- Best-looking layout (tight, rectangular, no gaps) -->
  <!-- Row 1: Player(5) + Sandy(7) -->
  <section class="win" data-w="5" id="playerWin">
    <div class="titlebar"><div class="caption">music player</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content">
      <div class="playerWrap">
        <div class="album"><div class="frame"><img id="albumArt" alt="snoopy art"/></div></div>
        <div class="controlsBar">
          <div class="ctrlRow">
            <button class="btnBox" id="prevBtn">◄</button>
            <button class="btnBox" id="playBtn">▶</button>
            <button class="btnBox" id="nextBtn">►</button>
          </div>
          <div class="ctrlRow"><span class="track" id="trackName"></span></div>
          <div class="ctrlRow right" style="gap:12px;">
            <label style="font-weight:600;color:#0b3e5b;">Vol</label>
            <input type="range" min="0" max="100" value="15" id="vol" class="volume">
          </div>
          <input type="range" min="0" max="100" value="0" id="seek" class="seek">
        </div>
        <audio id="audio" preload="auto" muted playsinline></audio>
      </div>
    </div>
  </section>

  <section class="win" data-w="7">
    <div class="titlebar"><div class="caption">sandysrocket.png</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content thumb"><img src="$SPONGE" alt="Sandy's Rocket"/></div>
  </section>

  <!-- Row 2: Cow(4) + Geo(3) + Parrots(5) -->
  <section class="win" data-w="4">
    <div class="titlebar"><div class="caption">moo.png</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content thumb"><img src="$COW1" alt="Highland cow"/></div>
  </section>

  <section class="win" data-w="3">
    <div class="titlebar"><div class="caption">Geoguessr</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content">
      <div class="thumb"><img src="$GEOIMG" alt="GeoGuessr marker"/></div>
      <p style="margin-top:8px; text-align:center"><a class="cta" target="_blank" rel="noopener" href="https://raiseyourgame.com/2025/07/31/how-geoguessr-pros-narrow-map/">Read my Raise Your Game blog about GeoGuessr here →</a></p>
    </div>
  </section>

  <section class="win" data-w="5">
    <div class="titlebar"><div class="caption">myparrots.png</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content thumb"><img src="$PARROTS" alt="Parrots"/></div>
  </section>

  <!-- Row 3: Cow2(7) + Steam(2) + MusicExp(3) -->
  <section class="win" data-w="7">
    <div class="titlebar"><div class="caption">mooooooo.png</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content thumb"><img src="$COW2" alt="Highland cow & calf"/></div>
  </section>

  <section class="win" data-w="2">
    <div class="titlebar"><div class="caption">Steam profile</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content steambox">
      <p style="margin:4px 0 10px 0">This is my Steam — add me or check out what I’m playing.</p>
      <a class="steambtn" target="_blank" rel="noopener" href="https://steamcommunity.com/profiles/76561198221106388/">
        <img alt="" src="$STEAM"/> Open Steam
      </a>
    </div>
  </section>

  <section class="win" data-w="3">
    <div class="titlebar"><div class="caption">music experience</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content">
      <ul style="list-style:none;padding:0;margin:0;line-height:1.55">
        <li>• shoegaze / ambient music producer</li>
        <li>• kurate music collective</li>
        <li>• 50k monthly listeners · 250k streams monthly</li>
        <li>• guitar/bass player</li>
      </ul>
    </div>
  </section>

  <!-- Row 4: Drexel(8) + Mr Fox(4) -->
  <section class="win" data-w="8">
    <div class="titlebar"><div class="caption">drexel university</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content">
      <ul style="list-style:none;padding:0;margin:0;line-height:1.55">
        <li>• bachelor of science in computer engineering · class of ’26</li>
        <li>• concentration in security technology</li>
        <li>• software engineer @ lockheed martin (2 yrs)</li>
        <li>• security monitoring co-op @ susquehanna international group</li>
      </ul>
    </div>
  </section>

  <section class="win" data-w="4">
    <div class="titlebar"><div class="caption">mrfox.png</div><div class="buttons"><div class="btnBox">–</div><div class="btnBox">□</div><div class="btnBox">×</div></div></div>
    <div class="content">
      <div class="thumb"><img src="$FOX" alt="Mr Fox tree"/></div>
      <blockquote style="margin:8px 0 0 0; font-style:italic; color:#5a3c06;">“I understand what you're saying, and your comments are valuable, but I'm gonna ignore your advice.”</blockquote>
    </div>
  </section>

</div>

<script>
// Masonry sizing; packs items tightly to eliminate gaps
(function(){
  const grid = document.getElementById('grid');
  const rowSize = parseInt(getComputedStyle(grid).getPropertyValue('--row'));
  function resizeItem(item){
    const titleH = 28;
    const content = item.querySelector('.content');
    const total = titleH + content.getBoundingClientRect().height + 8;
    const rowSpan = Math.ceil((total + 12) / (rowSize + 12));
    item.style.gridRowEnd = 'span ' + rowSpan;
    const cols = getComputedStyle(grid).getPropertyValue('grid-template-columns').split(' ').length;
    const want = parseInt(item.getAttribute('data-w')||4);
    item.style.gridColumn = 'span ' + Math.min(want, cols);
  }
  function resizeAll(){ document.querySelectorAll('.win').forEach(resizeItem); }
  window.addEventListener('load', resizeAll);
  Array.from(document.images).forEach(img => img.addEventListener('load', resizeAll, {once:true}));
  window.addEventListener('resize', resizeAll);
})();

// Snoopy art mapping with no adjacent duplicates (including wrap-around)
const snoopyList = $SNOOPY_LIST;
const snoopyIndexMap = [0,1,2,3,4,1]; // neighbors differ and wrap (6->1) differs
function artForIndex(i){ return snoopyList[ snoopyIndexMap[i % snoopyIndexMap.length] ]; }

// Player
const tracks=[
  {file:"audio/mice_on_venus.mp3", title:"mice_on_venus"},
  {file:"audio/comfort_chain.mp3", title:"comfort_chain"},
  {file:"audio/aquatic_ambience.mp3", title:"aquatic_ambience"},
  {file:"audio/mistake.mp3", title:"mistake"},
  {file:"audio/warm_nights.mp3", title:"warm_nights"},
  {file:"audio/tell_me.mp3", title:"tell_me"}
];
let current=0;
const audio=document.getElementById('audio');
const trackName=document.getElementById('trackName');
const playBtn=document.getElementById('playBtn');
const nextBtn=document.getElementById('nextBtn');
const prevBtn=document.getElementById('prevBtn');
const seek=document.getElementById('seek');
const vol=document.getElementById('vol');
const album=document.getElementById('albumArt');

function load(i){
  current=(i+tracks.length)%tracks.length;
  audio.src=tracks[current].file;
  trackName.textContent=tracks[current].title;
  album.src=artForIndex(current);
  audio.load();
}
function togglePlay(){ if(audio.paused){ audio.play(); playBtn.textContent="⏸"; } else { audio.pause(); playBtn.textContent="▶"; } }
nextBtn.onclick=()=>{ load(current+1); audio.play(); playBtn.textContent="⏸"; };
prevBtn.onclick=()=>{ load(current-1); audio.play(); playBtn.textContent="⏸"; };
playBtn.onclick=togglePlay;

audio.addEventListener('timeupdate', ()=>{ if(!isNaN(audio.duration)) seek.value=(audio.currentTime/audio.duration)*100; });
seek.addEventListener('input', ()=>{ if(!isNaN(audio.duration)) audio.currentTime=(seek.value/100)*audio.duration; });
vol.addEventListener('input', ()=>{ audio.volume=vol.value/100; });
audio.addEventListener('ended', ()=> nextBtn.click());

// Immediate autoplay: muted start (allowed), fade up to 15%
function fadeTo(target, duration=800){
  const start = audio.volume; const steps = 20; const inc=(target-start)/steps;
  let n=0; const iv=setInterval(()=>{ n++; audio.volume=Math.max(0,Math.min(1,start+inc*n)); if(n>=steps){ clearInterval(iv); audio.volume=target; audio.muted=false; }}, duration/steps);
}
function initAutoplay(){
  audio.volume=0; audio.muted=true;
  load(0);
  const p=audio.play();
  if(p && typeof p.then==="function"){ p.then(()=>{ fadeTo(0.15,900); playBtn.textContent="⏸"; })
    .catch(()=>{ /* retry muted */ let tries=0; const t=setInterval(()=>{ tries++; audio.play().then(()=>{ clearInterval(t); fadeTo(0.15,900); playBtn.textContent="⏸"; }).catch(()=>{ if(tries>8) clearInterval(t); }); }, 400); }); }
}
window.addEventListener('load', initAutoplay);
</script>
</body>
</html>
""")

html = tmpl.substitute(
    FAVICON=favicon,
    BG=data["bgAero"],
    SPONGE=data["spongebob"],
    COW1=data["cow1"],
    COW2=data["cow2"],
    PARROTS=data["parrots"],
    FOX=data["fox"],
    GEOIMG=data["geo"],
    STEAM=data["steam"],
    SNOOPY_LIST=json.dumps(snoopy_list)
)

open("/mnt/data/index.html","w",encoding="utf-8").write(html)
"/mnt/data/index.html"
